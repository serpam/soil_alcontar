---
title: "Pre- and post-fire anaylisis of soils" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---



```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="100")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               autodep = TRUE)
```

```{r pkgs}
library("tidyverse")
library("here")
library("janitor")
library("ggpubr")
library(fitdistrplus)
library(lme4)
library(lmerTest)
library(emmeans)
library(multcomp)
library(performance)
library(afex)
```

# Prepare data 
```{r prepare-data, echo=TRUE}
raw_soil <- readxl::read_excel(
  here::here("data/Resultados_Suelos_2018_2021_v2.xlsx"),
  sheet = "SEGUIMIENTO_MUESTRAS_SUELOS"
) %>% 
  janitor::clean_names() %>% 
  mutate(
    treatment_name =
      case_when(
        str_detect(geo_parcela_nombre, "NP_") ~ "Autumn Burning / No Browsing",
        str_detect(geo_parcela_nombre, "PR_") ~ "Spring Burning / Browsing",
        str_detect(geo_parcela_nombre, "P_") ~ "Autumn Burning / Browsing"
      ),
    zona =
      case_when(
        str_detect(geo_parcela_nombre, "NP_") ~ "NP",
        str_detect(geo_parcela_nombre, "PR_") ~ "PR",
        str_detect(geo_parcela_nombre, "P_") ~ "P"
      ),
    fecha = lubridate::ymd(fecha)
  ) 

```

- Select data pre- and intermediately post-fire (first post-fire sampling: "2018-12-20" and "2019-05-09" for autumn and spring fires respectively)

```{r, echo=TRUE}
soil <- raw_soil %>% 
  filter(fecha %in% lubridate::ymd(c("2018-12-11", "2018-12-20", "2019-04-24", "2019-05-09"))) %>% 
  mutate(zona = as.factor(zona), 
         pre_post_quema = as.factor(pre_post_quema)
  )
```

- Design structure of the data

```{r}
xtabs(~pre_post_quema+zona, data = soil)
```

# Models
- Analysis 

- mira esto https://doi.org/10.1186/s42408-018-0022-8 


- Explore distribution of the data fore each variable 
- Modelize 
- Post hocs 
- Plots 
```{r}
plot_interaction <- function(df, yvar){
  pos <- position_dodge(0.15)
  df %>%
    dplyr::select(UQ(yvar), 
                  pre_post_quema, 
                  zona) %>% 
    group_by(zona,pre_post_quema) %>% 
    summarise(mean = mean(.data[[yvar]], na.rm=FALSE),
              se = plotrix::std.error(.data[[yvar]], na.rm = FALSE)) %>% 
    ggplot(aes(x=pre_post_quema, y = mean, 
               color = zona, shape = zona, group=zona)) + 
    geom_point(position = pos, size = 3) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), 
                  position = pos, witdh = .01) +
    geom_line(position = pos) +
    theme_pubr() + 
    ylab(yvar) + xlab("")
}
```


# Humedad 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$humedad, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "humedad"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
```{r}
m <- lme4::lmer(form, data = df_model)
anova(as_lmerModLmerTest(m))
```

```{r}
# Ojo para lo de la anova en lmer ver esto:  https://stat.ethz.ch/pipermail/r-sig-mixed-models/2018q1/026596.html
```


### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="humedad")
```


# CIC 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$cic, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "cic"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
```{r}
m <- lme4::lmer(form, data = df_model)
anova(as_lmerModLmerTest(m))
```

```{r}
# Ojo para lo de la anova en lmer ver esto:  https://stat.ethz.ch/pipermail/r-sig-mixed-models/2018q1/026596.html
```


### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="cic")
```


# % C 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$c_percent, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "c_percent"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
```{r}
m <- lme4::lmer(form, data = df_model)
anova(as_lmerModLmerTest(m))
```


### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="c_percent")
```






# % Fe 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$fe_percent, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "fe_percent"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="fe_percent")
```


# % K 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$k_percent, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "k_percent"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="k_percent")
```


# % Mg 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$mg_percent, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "mg_percent"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="mg_percent")
```


# C/N 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$c_n, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "c_n"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="c_n")
```










# P 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$p, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "p"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Negative Binomial 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer.nb(form, data = df_model)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="p")
```


# MO 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$mo, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "mo"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="mo")
```












# % N 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$n_percent, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "n_percent"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

#print("Normality, Random effects")
#performance::check_normality(model, effects = "random")
```

### Model 
- Beta (glmmADBM)
```{r, eval=FALSE}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)

df_model$geo_parcela_nombre <- as.factor(df_model$geo_parcela_nombre)

m <- glmmADMB::glmmadmb(
  n_percent ~ pre_post_quema * zona, 
  random= ~ 1 | zona/geo_parcela_nombre,
  data = df_model, family = "beta")
car::Anova(m)


ma <- afex::mixed(form, data=df_model)
afex::nice(ma)
```

- Beta glmmTMB
```{r}
library(glmmTMB)
mtbm <- glmmTMB::glmmTMB(formula = form,
                         family = beta_family (link = "logit"),
                         data = df_model)
```


### *Post-hocs*

```{r}
# ojo 
m <- mtbm
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="n_percent")
```


# % Na 
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soil$na_percent, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "na_percent"

df_model <- soil %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

print("Normality, Random effects")
performance::check_normality(model, effects = "random")
```

### Model 
- Beta (glmmADBM)
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
df_model$geo_parcela_nombre <- as.factor(df_model$geo_parcela_nombre)

m <- glmmADMB::glmmadmb(
  na_percent ~ pre_post_quema * zona, 
  random= ~ 1 | zona/geo_parcela_nombre,
  data = df_model, family = "beta")
car::Anova(m)


ma <- afex::mixed(form, data=df_model)
afex::nice(ma)
```

- Beta glmmTMB
```{r}
library(glmmTMB)
mtbm <- glmmTMB::glmmTMB(formula = form,
                         family = beta_family (link = "logit"),
                         data = df_model)
car::Anova(mtbm)
```


### *Post-hocs*

```{r}
# ojo 
m <- mtbm
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soil, yvar="na_percent")
```




soil <- raw_soil %>% 
  filter(fecha %in% lubridate::ymd(c("2018-12-11", "2018-12-20", "2019-04-24", "2019-05-09"))) %>% 
  mutate(zona = as.factor(zona), 
         pre_post_quema = as.factor(pre_post_quema)
  )









# NH4
- prepara datos 

```{r}
soilN <- raw_soil %>% 
  dplyr::select(zona, fecha, pre_post_quema, geo_parcela_nombre, 
                n_nh4, n_no3) %>% 
  drop_na() %>% 
  mutate(zona = as.factor(zona), 
         pre_post_quema = as.factor(pre_post_quema)
  )
  
xtabs(~pre_post_quema+zona, data = soilN)


soilN %>% 
  group_by(zona, pre_post_quema) %>% 
  summarise(N.nh4 = length(n_nh4),
            N.no3 = length(n_no3))
```

### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soilN$n_nh4, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "n_nh4"

df_model <- soilN %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

#print("Normality, Random effects")
#performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soilN, yvar="n_nh4")
```


# NO3
### Check distribution 
```{r}
# Cullen & Frey plot 
descdist(soilN$n_no3, boot = 1000)
```

### Normality & Homocedasticity
```{r}
yvar <- "n_no3"

df_model <- soilN %>% 
  dplyr::select(one_of(c(yvar,"pre_post_quema", "zona", "geo_parcela_nombre")))
form <- reformulate("pre_post_quema * zona + (1|zona:geo_parcela_nombre)", 
                    response = yvar)
model <- lme4::lmer(form, data = df_model)

plot(performance::check_distribution(model)) 

print("Variances homogeneity?")
performance::check_homogeneity(model)

print("Normality?")
performance::check_normality(model)

#print("Normality, Random effects")
#performance::check_normality(model, effects = "random")
```

### Model 
- Gamma 
```{r}
# See here https://zian999.github.io/posts/2019/lrt_pvalues_for_glmer/ 
m <- lme4::glmer(form, data = df_model, family= Gamma)
afex::mixed(form, data=df_model)
```

### *Post-hocs*

```{r}
emmeans(m, list(pairwise ~ pre_post_quema), adjust = "tukey")
emmeans(m, list(pairwise ~ zona), adjust = "tukey")
emmeans(m, list(pairwise ~ pre_post_quema | zona), adjust = "tukey")
```

```{r}
plot_interaction(df=soilN, yvar="n_no3")
```

# Resumen general 











